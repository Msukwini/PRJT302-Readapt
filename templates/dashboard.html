{% extends "base.html" %}

{% block title %}Dashboard - Readapt{% endblock %}

{% block content %}
<div class="container">
    <div class="welcome-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>Welcome back, {% if current_user.is_authenticated %}{{ current_user.name }}{% else %}Student{% endif %}!</h2>
                <p>Your AI-powered adaptive learning journey continues. Let's pick up where you left off.</p>
            </div>
            <div style="text-align: center; padding: 20px; background: rgba(102, 126, 234, 0.1); border-radius: 12px;">
                <div style="font-size: 14px; color: #666;">Your Level</div>
                <div style="font-size: 48px; font-weight: bold; color: #667eea;" id="student-level">3</div>
                <div style="font-size: 14px; color: #666;" id="level-label">Intermediate</div>
            </div>
        </div>
    </div>

    <!-- ML System Status -->
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="color: white;">ðŸš€ AI System Status</h3>
        <div class="progress-section">
            <div class="progress-card" style="background: rgba(255,255,255,0.15);">
                <div class="progress-value" id="dash-svm-acc">--</div>
                <div class="progress-label">Model Accuracy</div>
            </div>
            <div class="progress-card" style="background: rgba(255,255,255,0.15);">
                <div class="progress-value" id="dash-gpu-status">--</div>
                <div class="progress-label">GPU Status</div>
            </div>
            <div class="progress-card" style="background: rgba(255,255,255,0.15);">
                <div class="progress-value" id="dash-gpt2-status">--</div>
                <div class="progress-label">GPT-2 Model</div>
            </div>
            <div class="progress-card" style="background: rgba(255,255,255,0.15);">
                <div class="progress-value" id="dash-response-time">&lt;2s</div>
                <div class="progress-label">Avg. Gen Time</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Learning Progress</h3>
        <div class="progress-section">
            <div class="progress-card">
                <div class="progress-value">75%</div>
                <div class="progress-label">Overall Progress</div>
            </div>
            <div class="progress-card">
                <div class="progress-value">12</div>
                <div class="progress-label">AI-Generated Lessons</div>
            </div>
            <div class="progress-card">
                <div class="progress-value">42</div>
                <div class="progress-label">Passages Read</div>
            </div>
            <div class="progress-card">
                <div class="progress-value">85%</div>
                <div class="progress-label">Avg. Score</div>
            </div>
        </div>
    </div>

    <!-- Quick Start AI Quiz -->
    <div class="card">
        <h3>ðŸŽ¯ Start AI-Powered Learning</h3>
        <p style="color: #666; margin-bottom: 20px;">Generate personalized reading comprehension exercises with GPU-accelerated AI</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <button class="btn btn-primary" onclick="quickStart('science', 'intermediate')" style="padding: 20px;">
                <i class="fas fa-flask" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                <strong>Science Quiz</strong>
                <div style="font-size: 12px; margin-top: 5px;">AI-generated â€¢ Your level</div>
            </button>
            <button class="btn btn-primary" onclick="quickStart('technology', 'intermediate')" style="padding: 20px;">
                <i class="fas fa-laptop-code" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                <strong>Technology Quiz</strong>
                <div style="font-size: 12px; margin-top: 5px;">GPU-accelerated â€¢ Your level</div>
            </button>
            <button class="btn btn-primary" onclick="quickStart('environment', 'intermediate')" style="padding: 20px;">
                <i class="fas fa-leaf" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                <strong>Environment Quiz</strong>
                <div style="font-size: 12px; margin-top: 5px;">ML-powered â€¢ Your level</div>
            </button>
            <button class="btn btn-outline" onclick="window.location.href='{{ url_for('generate_quiz') }}'" style="padding: 20px;">
                <i class="fas fa-cog" style="font-size: 24px; display: block; margin-bottom: 10px;"></i>
                <strong>Custom Quiz</strong>
                <div style="font-size: 12px; margin-top: 5px;">Choose topic & difficulty</div>
            </button>
        </div>
    </div>

    <!-- Live Content Preview -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">ðŸ¤– AI Content Preview</h3>
            <button class="btn btn-outline" onclick="refreshPreview()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <div id="preview-container" style="padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 150px;">
            <div style="text-align: center; color: #666;">
                <i class="fas fa-robot" style="font-size: 48px; margin-bottom: 15px;"></i>
                <p>Click "Refresh" to generate a sample passage with AI</p>
            </div>
        </div>
        <div id="preview-info" style="margin-top: 15px; padding: 12px; background: #e8f4f8; border-radius: 6px; display: none;">
            <p style="margin: 0; font-size: 13px;">
                <strong>Generation Info:</strong> <span id="preview-details"></span>
            </p>
        </div>
    </div>

    <div class="card">
        <h3>Your Adaptive Learning Path</h3>
        <p style="color: #666; margin-bottom: 20px;">
            <i class="fas fa-brain"></i> Difficulty levels automatically adjusted by our SVM model with <strong id="model-acc-inline">99%</strong> accuracy
        </p>
        <div class="learning-path">
            <div class="path-item">
                <div class="path-icon">
                    <i class="fas fa-code"></i>
                </div>
                <div class="path-content">
                    <h4>Introduction to Programming</h4>
                    <p>Completed with 92% mastery</p>
                    <small style="color: #666;">âœ… AI verified completion</small>
                </div>
                <div class="path-status status-completed">Completed</div>
            </div>
            <div class="path-item">
                <div class="path-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="path-content">
                    <h4>Data Structures & Algorithms</h4>
                    <p>Current focus based on your learning pattern</p>
                    <p><strong>Adaptive Difficulty: Intermediate (Level 3)</strong></p>
                    <small style="color: #666;">ðŸŽ® GPU-generated content</small>
                </div>
                <div class="path-status status-current">In Progress</div>
            </div>
            <div class="path-item">
                <div class="path-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="path-content">
                    <h4>Object-Oriented Programming</h4>
                    <p>Recommended based on your progress</p>
                    <small style="color: #666;">ðŸ¤– ML recommendation</small>
                </div>
                <div class="path-status status-upcoming">Up Next</div>
            </div>
        </div>
        <a href="{{ url_for('generate_quiz') }}" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
            <i class="fas fa-play"></i> Continue Learning with AI
        </a>
    </div>

    <!-- AI Insights -->
    <div class="card">
        <h3>ðŸ’¡ AI-Powered Insights</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
            <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                <i class="fas fa-chart-line" style="font-size: 32px; margin-bottom: 10px;"></i>
                <h4 style="color: white; margin: 10px 0;">Predicted Progress</h4>
                <p style="font-size: 14px; margin: 0;">ML model predicts 90% mastery in <strong>3 weeks</strong> with consistent practice</p>
            </div>
            <div style="padding: 20px; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); border-radius: 12px; color: white;">
                <i class="fas fa-target" style="font-size: 32px; margin-bottom: 10px;"></i>
                <h4 style="color: white; margin: 10px 0;">Optimal Difficulty</h4>
                <p style="font-size: 14px; margin: 0;">SVM recommends <strong>Level 3-4</strong> passages for maximum learning efficiency</p>
            </div>
            <div style="padding: 20px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 12px; color: white;">
                <i class="fas fa-bolt" style="font-size: 32px; margin-bottom: 10px;"></i>
                <h4 style="color: white; margin: 10px 0;">GPU Advantage</h4>
                <p style="font-size: 14px; margin: 0;">Content generation <strong>10x faster</strong> with GPU acceleration enabled</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let studentLevel = 3;

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    updateLevelDisplay();
});

// Load dashboard ML statistics
async function loadDashboardData() {
    try {
        const response = await fetch('/api/model-stats');
        const data = await response.json();
        
        // Update ML system status
        document.getElementById('dash-svm-acc').textContent = data.svm_accuracy.toFixed(1) + '%';
        document.getElementById('model-acc-inline').textContent = data.svm_accuracy.toFixed(1) + '%';
        
        const gpuInfo = data.gpu_info;
        if (gpuInfo.available) {
            document.getElementById('dash-gpu-status').textContent = 'âœ… Active';
            document.getElementById('dash-gpt2-status').textContent = gpuInfo.gpt2_on_gpu ? 'âœ… GPU' : 'ðŸ’» CPU';
        } else {
            document.getElementById('dash-gpu-status').textContent = 'ðŸ’» CPU';
            document.getElementById('dash-gpt2-status').textContent = 'ðŸ’» CPU';
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Update level display
function updateLevelDisplay() {
    const levelLabels = {
        1: 'Beginner', 
        2: 'Easy', 
        3: 'Intermediate', 
        4: 'Intermediate+', 
        5: 'Advanced', 
        6: 'Expert'
    };
    
    document.getElementById('student-level').textContent = studentLevel;
    document.getElementById('level-label').textContent = levelLabels[studentLevel];
}

// Quick start quiz
function quickStart(topic, difficulty) {
    showNotification('Launching AI-powered quiz...', 'info');
    window.location.href = `/generate-quiz?topic=${topic}&difficulty=${difficulty}`;
}

// Refresh preview
async function refreshPreview() {
    const previewContainer = document.getElementById('preview-container');
    const previewInfo = document.getElementById('preview-info');
    
    previewContainer.innerHTML = '<div style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #667eea;"></i><p style="margin-top: 15px;">Generating sample passage with AI...</p></div>';
    
    const topics = ['science', 'technology', 'history', 'literature', 'environment'];
    const topic = topics[Math.floor(Math.random() * topics.length)];
    const startTime = performance.now();
    
    try {
        const response = await fetch('/api/ml/generate-passage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                topic: topic,
                difficulty: 'intermediate',
                max_length: 150
            })
        });
        
        const data = await response.json();
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        // Display passage
        previewContainer.innerHTML = `
            <div style="margin-bottom: 15px;">
                <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                    ${topic.toUpperCase()}
                </span>
            </div>
            <p style="line-height: 1.8; color: #333;">${data.passage}</p>
        `;
        
        // Show info
        previewInfo.style.display = 'block';
        const deviceIcon = data.used_gpu ? 'ðŸŽ® GPU' : 'ðŸ’» CPU';
        document.getElementById('preview-details').textContent = 
            `Generated on ${deviceIcon} | Response time: ${responseTime}ms | Topic: ${topic}`;
        
        // Update response time
        document.getElementById('dash-response-time').textContent = (responseTime / 1000).toFixed(1) + 's';
        
        showNotification('Sample passage generated successfully!', 'success');
        
    } catch (error) {
        console.error('Error generating preview:', error);
        previewContainer.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 30px;"><i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i><p style="margin-top: 15px;">Error generating preview. Please try again.</p></div>';
        showNotification('Error generating preview', 'error');
    }
}

// Notification helper
function showNotification(message, type = 'info') {
    const flashContainer = document.querySelector('.flash-messages') || createFlashContainer();
    const messageDiv = document.createElement('div');
    messageDiv.className = `flash-message flash-${type}`;
    messageDiv.textContent = message;
    flashContainer.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

function createFlashContainer() {
    const container = document.createElement('div');
    container.className = 'flash-messages';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
