{% extends "base.html" %}

{% block title %}Admin Dashboard - Readapt{% endblock %}

{% block content %}
<div class="container">
    <!-- Admin Header with ML Stats -->
    <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <p>GPU-Accelerated Adaptive Learning Platform</p>
        
        <!-- ML System Status -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
            <h3 style="color: white;">üöÄ ML System Status</h3>
            <div class="performance-grid">
                <div class="metric">
                    <div class="metric-value" id="svm-accuracy">--</div>
                    <div class="metric-label">SVM Accuracy</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="svm-f1">--</div>
                    <div class="metric-label">F1-Score</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="gpu-status">--</div>
                    <div class="metric-label">GPU Status</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="test-samples">--</div>
                    <div class="metric-label">Test Samples</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <p style="margin: 5px 0;"><strong>GPU:</strong> <span id="gpu-name">Loading...</span></p>
                <p style="margin: 5px 0;"><strong>Models:</strong> SVM: <span id="svm-loaded">‚ùå</span> | GPT-2: <span id="gpt2-loaded">‚ùå</span></p>
                <p style="margin: 5px 0;"><strong>GPU Acceleration:</strong> SVM: <span id="svm-gpu">‚ùå</span> | GPT-2: <span id="gpt2-gpu">‚ùå</span></p>
            </div>
        </div>
        
        <div class="admin-stats-overview">
            <div class="stat-card admin-stat">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ model_stats.get('train_samples', 1247) }}</div>
                    <div class="stat-label">Training Samples</div>
                    <div class="stat-change positive">ML Dataset</div>
                </div>
            </div>
            <div class="stat-card admin-stat">
                <div class="stat-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">45</div>
                    <div class="stat-label">Active Courses</div>
                    <div class="stat-change positive">+3 new</div>
                </div>
            </div>
            <div class="stat-card admin-stat">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ "%.1f"|format(model_stats.get('svm_accuracy', 87)) }}%</div>
                    <div class="stat-label">Model Accuracy</div>
                    <div class="stat-change positive">Target: 99%</div>
                </div>
            </div>
            <div class="stat-card admin-stat">
                <div class="stat-icon">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="gpu-status-icon">üéÆ</div>
                    <div class="stat-label">GPU Enabled</div>
                    <div class="stat-change positive" id="gpu-info-text">Checking...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <h3>ML Quick Actions</h3>
        <div class="quick-actions">
            <button class="action-btn" onclick="testContentGeneration()">
                <i class="fas fa-robot"></i>
                <span>Test Content Gen</span>
            </button>
            <button class="action-btn" onclick="testDifficultyPrediction()">
                <i class="fas fa-brain"></i>
                <span>Test Difficulty</span>
            </button>
            <button class="action-btn" onclick="viewModelPerformance()">
                <i class="fas fa-chart-bar"></i>
                <span>Model Performance</span>
            </button>
            <button class="action-btn" onclick="window.location.href='{{ url_for('analytics') }}'">
                <i class="fas fa-analytics"></i>
                <span>Analytics</span>
            </button>
            <button class="action-btn" onclick="checkSystemInfo()">
                <i class="fas fa-info-circle"></i>
                <span>System Info</span>
            </button>
            <button class="action-btn" onclick="refreshMLStats()">
                <i class="fas fa-sync"></i>
                <span>Refresh Stats</span>
            </button>
        </div>
    </div>

    <div class="admin-grid">
        <!-- Recent Users -->
        <div class="card">
            <div class="card-header">
                <h3>Recent Users</h3>
                <a href="#" class="view-all">View All</a>
            </div>
            <div class="user-list">
                {% for user in recent_users %}
                <div class="user-item">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name">{{ user.name }}</div>
                        <div class="user-email">{{ user.email }}</div>
                    </div>
                    <div class="user-stats">
                        <div class="user-progress">{{ user.progress }}%</div>
                        <div class="user-status {{ user.status }}">{{ user.status|title }}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-icon" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" title="Message">
                            <i class="fas fa-envelope"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ML Content Test -->
        <div class="card">
            <div class="card-header">
                <h3>Live Content Generation Test</h3>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <label>Topic:</label>
                    <input type="text" id="test-topic" value="artificial intelligence" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>Difficulty:</label>
                    <select id="test-difficulty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="easy">Easy</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="generateTestContent()" style="width: 100%;">
                    <i class="fas fa-magic"></i> Generate Content
                </button>
                <div id="generated-content" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <h4>Generated Passage:</h4>
                    <p id="generated-passage" style="font-size: 14px; line-height: 1.6;"></p>
                    <h4 style="margin-top: 15px;">Questions:</h4>
                    <ul id="generated-questions"></ul>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        <span id="generation-gpu-status"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- System Analytics -->
        <div class="card">
            <h3>System Analytics</h3>
            <div class="analytics-chart">
                <div class="chart-placeholder">
                    <i class="fas fa-chart-bar"></i>
                    <p>ML Model Performance</p>
                    <div class="chart-stats">
                        <div class="chart-stat">
                            <div class="value" id="chart-accuracy">--</div>
                            <div class="label">SVM Accuracy</div>
                        </div>
                        <div class="chart-stat">
                            <div class="value" id="chart-f1">--</div>
                            <div class="label">F1-Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h3>Recent Activity</h3>
                <a href="#" class="view-all">View All</a>
            </div>
            <div class="activity-list">
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon {{ activity.type }}">
                        <i class="fas fa-{{ activity.icon }}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-message">{{ activity.message }}</div>
                        <div class="activity-time">{{ activity.time }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Platform Performance -->
        <div class="card full-width">
            <h3>Platform Performance</h3>
            <div class="performance-grid">
                <div class="metric">
                    <div class="metric-value">99.8%</div>
                    <div class="metric-label">Uptime</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>0.1%</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avg-response">--ms</div>
                    <div class="metric-label">ML Response Time</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-bolt"></i>
                        <span>GPU</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value">2.4GB</div>
                    <div class="metric-label">Storage Used</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>0.3GB</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value">98%</div>
                    <div class="metric-label">User Satisfaction</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>2%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load ML stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMLStats();
    
    // Add animation to stat cards
    const statCards = document.querySelectorAll('.admin-stat');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Quick actions animation
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach((btn, index) => {
        setTimeout(() => {
            btn.style.opacity = '1';
            btn.style.transform = 'scale(1)';
        }, index * 50);
    });
});

// Load ML Statistics
async function loadMLStats() {
    try {
        const response = await fetch('/api/model-stats');
        const data = await response.json();
        
        // Update accuracy displays
        document.getElementById('svm-accuracy').textContent = data.svm_accuracy.toFixed(2) + '%';
        document.getElementById('svm-f1').textContent = data.svm_f1_score.toFixed(2) + '%';
        document.getElementById('test-samples').textContent = data.test_samples;
        document.getElementById('chart-accuracy').textContent = data.svm_accuracy.toFixed(1) + '%';
        document.getElementById('chart-f1').textContent = data.svm_f1_score.toFixed(1) + '%';
        
        // GPU info
        const gpuInfo = data.gpu_info;
        if (gpuInfo.available) {
            document.getElementById('gpu-status').textContent = '‚úÖ Active';
            document.getElementById('gpu-name').textContent = gpuInfo.name;
            document.getElementById('gpu-status-icon').textContent = 'üéÆ';
            document.getElementById('gpu-info-text').textContent = 'Active';
        } else {
            document.getElementById('gpu-status').textContent = 'üíª CPU';
            document.getElementById('gpu-name').textContent = 'CPU Mode';
            document.getElementById('gpu-status-icon').textContent = 'üíª';
            document.getElementById('gpu-info-text').textContent = 'CPU Mode';
        }
        
        // Model loading status
        document.getElementById('svm-loaded').textContent = data.models_loaded.svm ? '‚úÖ' : '‚ùå';
        document.getElementById('gpt2-loaded').textContent = data.models_loaded.gpt2 ? '‚úÖ' : '‚ùå';
        document.getElementById('svm-gpu').textContent = gpuInfo.svm_on_gpu ? '‚úÖ' : '‚ùå';
        document.getElementById('gpt2-gpu').textContent = gpuInfo.gpt2_on_gpu ? '‚úÖ' : '‚ùå';
        
    } catch (error) {
        console.error('Error loading ML stats:', error);
        showNotification('Error loading ML statistics', 'error');
    }
}

// Generate test content
async function generateTestContent() {
    const topic = document.getElementById('test-topic').value;
    const difficulty = document.getElementById('test-difficulty').value;
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    const startTime = performance.now();
    
    try {
        const response = await fetch('/api/generate-content', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({topic, difficulty})
        });
        
        const data = await response.json();
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        // Display generated content
        document.getElementById('generated-passage').textContent = data.passage;
        
        const questionsList = document.getElementById('generated-questions');
        questionsList.innerHTML = '';
        data.questions.forEach(q => {
            const li = document.createElement('li');
            li.textContent = q;
            li.style.marginBottom = '8px';
            questionsList.appendChild(li);
        });
        
        const gpuStatus = data.used_gpu ? 'üéÆ Generated on GPU' : 'üíª Generated on CPU';
        document.getElementById('generation-gpu-status').textContent = 
            `${gpuStatus} | Response time: ${responseTime}ms`;
        
        document.getElementById('generated-content').style.display = 'block';
        document.getElementById('avg-response').textContent = responseTime + 'ms';
        
        showNotification('Content generated successfully!', 'success');
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error generating content', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Test difficulty prediction
async function testDifficultyPrediction() {
    const testText = "Artificial intelligence encompasses machine learning, neural networks, and deep learning techniques that enable computers to perform tasks requiring human intelligence.";
    
    try {
        const response = await fetch('/api/predict-difficulty', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: testText})
        });
        
        const data = await response.json();
        const gpuStatus = data.used_gpu ? 'üéÆ GPU' : 'üíª CPU';
        
        alert(`Difficulty Prediction:\n\nLevel: ${data.level}\nLabel: ${data.label}\nConfidence: ${(data.confidence * 100).toFixed(1)}%\nDevice: ${gpuStatus}`);
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error predicting difficulty', 'error');
    }
}

// View model performance
function viewModelPerformance() {
    window.open('/results/model_performance_results.png', '_blank');
}

// Check system info
async function checkSystemInfo() {
    try {
        const response = await fetch('/api/ml/system-info');
        const data = await response.json();
        
        let info = 'ML System Information:\n\n';
        info += `GPU Available: ${data.gpu_available ? 'Yes' : 'No'}\n`;
        if (data.gpu_available) {
            info += `GPU Name: ${data.gpu_name}\n`;
            info += `GPU Memory: ${data.gpu_memory_gb} GB\n`;
            info += `CUDA Version: ${data.cuda_version}\n`;
        }
        info += `\nSVM on GPU: ${data.svm_on_gpu ? 'Yes' : 'No'}\n`;
        info += `GPT-2 on GPU: ${data.gpt2_on_gpu ? 'Yes' : 'No'}`;
        
        alert(info);
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error fetching system info', 'error');
    }
}

// Refresh ML stats
function refreshMLStats() {
    showNotification('Refreshing ML statistics...', 'info');
    loadMLStats();
}

// Test content generation shortcut
function testContentGeneration() {
    document.getElementById('test-topic').focus();
}

// Notification helper
function showNotification(message, type) {
    const flashContainer = document.querySelector('.flash-messages') || createFlashContainer();
    const messageDiv = document.createElement('div');
    messageDiv.className = `flash-message flash-${type}`;
    messageDiv.textContent = message;
    flashContainer.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

function createFlashContainer() {
    const container = document.createElement('div');
    container.className = 'flash-messages';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
