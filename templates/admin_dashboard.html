{% extends "base.html" %}

{% block title %}Admin ML Dashboard - Readapt{% endblock %}

{% block content %}
<div class="container">
    <!-- Admin Header -->
    <div class="admin-header">
        <h1>üéØ ML System Administration Dashboard</h1>
        <p>GPU-Accelerated Adaptive Learning Platform - Technical Control Center</p>
        
        <!-- ML System Status -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
            <h3 style="color: white;">üöÄ Machine Learning System Status</h3>
            <div class="performance-grid">
                <div class="metric">
                    <div class="metric-value" id="svm-accuracy">Loading...</div>
                    <div class="metric-label">SVM Accuracy</div>
                    <small style="color: rgba(255,255,255,0.8);">Target: 99%</small>
                </div>
                <div class="metric">
                    <div class="metric-value" id="svm-f1">Loading...</div>
                    <div class="metric-label">F1-Score</div>
                    <small style="color: rgba(255,255,255,0.8);">Target: 95.39%</small>
                </div>
                <div class="metric">
                    <div class="metric-value" id="gpu-status">Checking...</div>
                    <div class="metric-label">GPU Status</div>
                    <small style="color: rgba(255,255,255,0.8);" id="gpu-name-mini">--</small>
                </div>
                <div class="metric">
                    <div class="metric-value" id="test-samples">--</div>
                    <div class="metric-label">Test Samples</div>
                    <small style="color: rgba(255,255,255,0.8);">Evaluation Set</small>
                </div>
            </div>
            
            <!-- Detailed System Info -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>üéÆ GPU Device:</strong>
                        <p style="margin: 5px 0;" id="gpu-full-name">Loading...</p>
                    </div>
                    <div>
                        <strong>üíæ GPU Memory:</strong>
                        <p style="margin: 5px 0;" id="gpu-memory">--</p>
                    </div>
                    <div>
                        <strong>üîß CUDA Version:</strong>
                        <p style="margin: 5px 0;" id="cuda-version">--</p>
                    </div>
                    <div>
                        <strong>üìä Training Samples:</strong>
                        <p style="margin: 5px 0;" id="train-samples">--</p>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <p style="margin: 0;"><strong>Model Status:</strong></p>
                    <p style="margin: 5px 0 0 0;">
                        SVM: <span id="svm-loaded">‚è≥</span> | 
                        GPT-2: <span id="gpt2-loaded">‚è≥</span> | 
                        SVM GPU: <span id="svm-gpu">‚è≥</span> | 
                        GPT-2 GPU: <span id="gpt2-gpu">‚è≥</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ML Quick Actions -->
    <div class="card">
        <h3>‚ö° ML Testing & Diagnostics</h3>
        <div class="quick-actions">
            <button class="action-btn" onclick="testContentGeneration()">
                <i class="fas fa-robot"></i>
                <span>Test GPT-2 Generation</span>
            </button>
            <button class="action-btn" onclick="testDifficultyPrediction()">
                <i class="fas fa-brain"></i>
                <span>Test SVM Prediction</span>
            </button>
            <button class="action-btn" onclick="viewModelPerformance()">
                <i class="fas fa-chart-bar"></i>
                <span>Model Performance</span>
            </button>
            <button class="action-btn" onclick="window.location.href='{{ url_for('analytics') }}'">
                <i class="fas fa-analytics"></i>
                <span>Analytics</span>
            </button>
            <button class="action-btn" onclick="checkSystemInfo()">
                <i class="fas fa-info-circle"></i>
                <span>Detailed System Info</span>
            </button>
            <button class="action-btn" onclick="refreshMLStats()">
                <i class="fas fa-sync"></i>
                <span>Refresh Stats</span>
            </button>
        </div>
    </div>

    <div class="admin-grid">
        <!-- Live Content Generation Test -->
        <div class="card">
            <div class="card-header">
                <h3>üß™ Live ML Content Generation</h3>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <label><strong>Topic:</strong></label>
                    <input type="text" id="test-topic" value="artificial intelligence" 
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label><strong>Difficulty:</strong></label>
                    <select id="test-difficulty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="easy">Easy</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="generateTestContent()" style="width: 100%;">
                    <i class="fas fa-magic"></i> Generate Content
                </button>
                <div id="generated-content" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <h4>Generated Passage:</h4>
                    <p id="generated-passage" style="font-size: 14px; line-height: 1.6;"></p>
                    <h4 style="margin-top: 15px;">Questions (<span id="gen-q-count">--</span>):</h4>
                    <ul id="generated-questions"></ul>
                    <div style="margin-top: 10px; padding: 10px; background: #e8f4f8; border-radius: 4px;">
                        <p style="margin: 0; font-size: 12px; color: #666;">
                            <strong>üìä Analysis:</strong><br>
                            Device: <span id="generation-gpu-status"></span><br>
                            Response Time: <span id="generation-time"></span>ms<br>
                            SVM Difficulty: Level <span id="predicted-level">--</span> (<span id="predicted-label">--</span>)<br>
                            Confidence: <span id="predicted-confidence">--</span>%
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Performance Metrics -->
        <div class="card">
            <h3>üìà Model Performance Metrics</h3>
            <div class="analytics-chart">
                <div class="chart-placeholder">
                    <i class="fas fa-chart-bar"></i>
                    <p>ML Model Performance</p>
                    <div class="chart-stats">
                        <div class="chart-stat">
                            <div class="value" id="chart-accuracy">--</div>
                            <div class="label">SVM Accuracy</div>
                        </div>
                        <div class="chart-stat">
                            <div class="value" id="chart-f1">--</div>
                            <div class="label">F1-Score</div>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewModelPerformance()" style="margin-top: 15px;">
                        View Full Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card full-width">
            <div class="card-header">
                <h3>üìä System Logs & Activity</h3>
            </div>
            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-icon system">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-message">ML models initialized successfully</div>
                        <div class="activity-time">System startup</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon course">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-message">SVM model loaded: <span id="log-svm-status">Checking...</span></div>
                        <div class="activity-time">Model loading</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon course">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-message">GPT-2 model loaded: <span id="log-gpt2-status">Checking...</span></div>
                        <div class="activity-time">Model loading</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon user">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-message">GPU status: <span id="log-gpu-status">Checking...</span></div>
                        <div class="activity-time">Hardware check</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Performance -->
        <div class="card full-width">
            <h3>‚öôÔ∏è Platform Performance</h3>
            <div class="performance-grid">
                <div class="metric">
                    <div class="metric-value">99.8%</div>
                    <div class="metric-label">Uptime</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>Stable</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avg-response">--ms</div>
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-bolt"></i>
                        <span id="response-device">--</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="content-generated">0</div>
                    <div class="metric-label">Content Generated</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>This Session</span>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="predictions-made">0</div>
                    <div class="metric-label">Predictions Made</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>This Session</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let contentGenCount = 0;
let predictionCount = 0;

// Load ML stats on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMLStats();
    
    // Animate stat cards
    const statCards = document.querySelectorAll('.admin-stat');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Animate action buttons
    const actionBtns = document.querySelectorAll('.action-btn');
    actionBtns.forEach((btn, index) => {
        setTimeout(() => {
            btn.style.opacity = '1';
            btn.style.transform = 'scale(1)';
        }, index * 50);
    });
});

// Load ML Statistics
async function loadMLStats() {
    try {
        const response = await fetch('/api/model-stats');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update main metrics
        document.getElementById('svm-accuracy').textContent = data.svm_accuracy.toFixed(2) + '%';
        document.getElementById('svm-f1').textContent = data.svm_f1_score.toFixed(2) + '%';
        document.getElementById('test-samples').textContent = data.test_samples;
        document.getElementById('train-samples').textContent = data.train_samples;
        document.getElementById('chart-accuracy').textContent = data.svm_accuracy.toFixed(1) + '%';
        document.getElementById('chart-f1').textContent = data.svm_f1_score.toFixed(1) + '%';
        
        // GPU info
        const gpuInfo = data.gpu_info;
        if (gpuInfo.available) {
            document.getElementById('gpu-status').textContent = '‚úÖ Active';
            document.getElementById('gpu-name-mini').textContent = 'GPU Enabled';
            document.getElementById('gpu-full-name').textContent = `‚úÖ ${gpuInfo.name}`;
            document.getElementById('gpu-memory').textContent = `${gpuInfo.gpu_memory_gb} GB`;
            document.getElementById('cuda-version').textContent = `v${gpuInfo.cuda_version}`;
            document.getElementById('response-device').textContent = 'GPU';
            
            // Logs
            document.getElementById('log-gpu-status').innerHTML = '<span style="color: #2ecc71;">‚úÖ Available (' + gpuInfo.name + ')</span>';
        } else {
            document.getElementById('gpu-status').textContent = 'üíª CPU';
            document.getElementById('gpu-name-mini').textContent = 'CPU Mode';
            document.getElementById('gpu-full-name').textContent = 'üíª CPU Mode (No GPU detected)';
            document.getElementById('gpu-memory').textContent = 'N/A';
            document.getElementById('cuda-version').textContent = 'N/A';
            document.getElementById('response-device').textContent = 'CPU';
            
            // Logs
            document.getElementById('log-gpu-status').innerHTML = '<span style="color: #f39c12;">‚ö†Ô∏è Not available (CPU mode)</span>';
        }
        
        // Model loading status
        const svmLoaded = data.models_loaded.svm;
        const gpt2Loaded = data.models_loaded.gpt2;
        
        document.getElementById('svm-loaded').innerHTML = svmLoaded ? '<span style="color: #2ecc71;">‚úÖ Loaded</span>' : '<span style="color: #e74c3c;">‚ùå Not loaded</span>';
        document.getElementById('gpt2-loaded').innerHTML = gpt2Loaded ? '<span style="color: #2ecc71;">‚úÖ Loaded</span>' : '<span style="color: #e74c3c;">‚ùå Not loaded</span>';
        document.getElementById('svm-gpu').innerHTML = gpuInfo.svm_on_gpu ? '<span style="color: #2ecc71;">‚úÖ GPU</span>' : '<span style="color: #95a5a6;">üíª CPU</span>';
        document.getElementById('gpt2-gpu').innerHTML = gpuInfo.gpt2_on_gpu ? '<span style="color: #2ecc71;">‚úÖ GPU</span>' : '<span style="color: #95a5a6;">üíª CPU</span>';
        
        // Logs
        document.getElementById('log-svm-status').innerHTML = svmLoaded ? '<span style="color: #2ecc71;">‚úÖ Ready</span>' : '<span style="color: #e74c3c;">‚ùå Failed</span>';
        document.getElementById('log-gpt2-status').innerHTML = gpt2Loaded ? '<span style="color: #2ecc71;">‚úÖ Ready</span>' : '<span style="color: #e74c3c;">‚ùå Failed</span>';
        
        // Update response time estimate
        document.getElementById('avg-response').textContent = gpuInfo.available ? '<200' : '<800';
        
    } catch (error) {
        console.error('Error loading ML stats:', error);
        showNotification('‚ö†Ô∏è Error loading ML statistics. Check if Flask server is running.', 'error');
        
        // Set error indicators
        document.getElementById('svm-accuracy').textContent = 'ERROR';
        document.getElementById('gpu-status').textContent = '‚ö†Ô∏è Error';
        document.getElementById('log-gpu-status').innerHTML = '<span style="color: #e74c3c;">‚ùå Connection failed</span>';
    }
}

// Generate test content
async function generateTestContent() {
    const topic = document.getElementById('test-topic').value;
    const difficulty = document.getElementById('test-difficulty').value;
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    const startTime = performance.now();
    
    try {
        // Generate passage
        const passageResp = await fetch('/api/ml/generate-passage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({topic, difficulty, max_length: 200})
        });
        
        if (!passageResp.ok) {
            throw new Error(`HTTP ${passageResp.status}`);
        }
        
        const passageData = await passageResp.json();
        
        // Generate questions
        const questionsResp = await fetch('/api/ml/generate-questions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({passage: passageData.passage, num_questions: 3})
        });
        
        if (!questionsResp.ok) {
            throw new Error(`HTTP ${questionsResp.status}`);
        }
        
        const questionsData = await questionsResp.json();
        
        // Predict difficulty
        const diffResp = await fetch('/api/ml/predict-difficulty', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: passageData.passage})
        });
        
        if (!diffResp.ok) {
            throw new Error(`HTTP ${diffResp.status}`);
        }
        
        const diffData = await diffResp.json();
        
        const endTime = performance.now();
        const responseTime = Math.round(endTime - startTime);
        
        // Display generated content
        document.getElementById('generated-passage').textContent = passageData.passage;
        
        const questionsList = document.getElementById('generated-questions');
        questionsList.innerHTML = '';
        questionsData.questions.forEach(q => {
            const li = document.createElement('li');
            li.textContent = q;
            li.style.marginBottom = '8px';
            questionsList.appendChild(li);
        });
        
        document.getElementById('gen-q-count').textContent = questionsData.questions.length;
        
        const gpuStatus = passageData.used_gpu ? 'üéÆ GPU' : 'üíª CPU';
        document.getElementById('generation-gpu-status').textContent = gpuStatus;
        document.getElementById('generation-time').textContent = responseTime;
        document.getElementById('predicted-level').textContent = diffData.level;
        document.getElementById('predicted-label').textContent = diffData.label.toUpperCase();
        document.getElementById('predicted-confidence').textContent = (diffData.confidence * 100).toFixed(1);
        
        document.getElementById('generated-content').style.display = 'block';
        document.getElementById('avg-response').textContent = responseTime + 'ms';
        
        // Update counters
        contentGenCount++;
        predictionCount++;
        document.getElementById('content-generated').textContent = contentGenCount;
        document.getElementById('predictions-made').textContent = predictionCount;
        
        showNotification('‚úÖ Content generated successfully!', 'success');
    } catch (error) {
        console.error('Error:', error);
        showNotification('‚ùå Error generating content: ' + error.message, 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Test difficulty prediction
async function testDifficultyPrediction() {
    const testText = "Artificial intelligence encompasses machine learning, neural networks, and deep learning techniques that enable computers to perform tasks requiring human intelligence.";
    
    try {
        const response = await fetch('/api/ml/predict-difficulty', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: testText})
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const gpuStatus = data.used_gpu ? 'üéÆ GPU' : 'üíª CPU';
        
        predictionCount++;
        document.getElementById('predictions-made').textContent = predictionCount;
        
        alert(`SVM Difficulty Prediction:\n\nLevel: ${data.level}\nLabel: ${data.label.toUpperCase()}\nConfidence: ${(data.confidence * 100).toFixed(1)}%\nDevice: ${gpuStatus}\n\nTest Text: "${testText.substring(0, 60)}..."`);
    } catch (error) {
        console.error('Error:', error);
        alert('Error predicting difficulty: ' + error.message);
    }
}

// View model performance
function viewModelPerformance() {
    window.open('/results/model_performance_results.png', '_blank');
}

// Check system info
async function checkSystemInfo() {
    try {
        const response = await fetch('/api/ml/system-info');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        let info = 'üñ•Ô∏è ML SYSTEM INFORMATION\n\n';
        info += `GPU Available: ${data.gpu_available ? 'Yes ‚úÖ' : 'No ‚ùå'}\n`;
        if (data.gpu_available) {
            info += `GPU Name: ${data.gpu_name}\n`;
            info += `GPU Memory: ${data.gpu_memory_gb} GB\n`;
            info += `CUDA Version: ${data.cuda_version}\n`;
            info += `PyTorch Version: ${data.torch_version}\n\n`;
            if (data.gpu_memory_allocated_gb !== undefined) {
                info += `GPU Memory Allocated: ${data.gpu_memory_allocated_gb} GB\n`;
                info += `GPU Memory Reserved: ${data.gpu_memory_reserved_gb} GB\n`;
            }
        }
        info += `\nüìä MODEL STATUS\n\n`;
        info += `SVM on GPU: ${data.svm_on_gpu ? 'Yes ‚úÖ' : 'No (CPU)'}\n`;
        info += `GPT-2 on GPU: ${data.gpt2_on_gpu ? 'Yes ‚úÖ' : 'No (CPU)'}\n`;
        info += `cuML Available: ${data.cuml_available ? 'Yes ‚úÖ' : 'No'}\n`;
        
        alert(info);
    } catch (error) {
        console.error('Error:', error);
        alert('Error fetching system info: ' + error.message);
    }
}

// Refresh ML stats
function refreshMLStats() {
    showNotification('üîÑ Refreshing ML statistics...', 'info');
    loadMLStats();
}

// Test content generation shortcut
function testContentGeneration() {
    document.getElementById('test-topic').focus();
}

// Notification helper
function showNotification(message, type) {
    const flashContainer = document.querySelector('.flash-messages') || createFlashContainer();
    const messageDiv = document.createElement('div');
    messageDiv.className = `flash-message flash-${type}`;
    messageDiv.textContent = message;
    flashContainer.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideInRight 0.3s ease reverse';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

function createFlashContainer() {
    const container = document.createElement('div');
    container.className = 'flash-messages';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
